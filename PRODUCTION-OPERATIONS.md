# 江西酒店管理系统 - 生产环境运维和监控指南

## 概述

本文档提供江西酒店管理系统在生产环境中的运维和监控指南，包括系统监控、性能优化、故障处理和日常维护。

## 监控配置

### 应用监控

#### API 性能监控
- **API 响应时间**: 监控所有 API 端点的响应时间
- **阈值**: 超过 2 秒的请求发出警告
- **监控指标**: 
  - 平均响应时间
  - P95/P99 响应时间
  - 错误率
  - 请求量

#### 数据库性能监控
- **数据库操作时间**: 监控所有数据库操作的执行时间
- **阈值**: 超过 1 秒的操作发出警告
- **监控指标**:
  - 查询执行时间
  - 连接池使用情况
  - 数据库连接数
  - 慢查询数量

#### 系统健康监控
- **内存使用**: 监控应用内存使用情况
- **CPU 使用率**: 监控服务器 CPU 使用率
- **错误率**: 监控应用错误发生率
- **可用性**: 监控系统可用性指标

### 监控工具配置

#### 内置监控服务
系统已集成 `services/monitoring.ts`，提供以下功能：

```typescript
// 监控服务特点
- 性能指标收集
- 错误日志记录
- 敏感数据脱敏
- 生产环境日志过滤
- 性能阈值告警
```

#### 日志管理
- **日志级别**: info, warn, error, debug (生产环境仅记录 error 和 warn)
- **日志格式**: JSON 格式，包含时间戳、级别、消息和上下文
- **敏感数据处理**: 自动脱敏密码、token 等敏感信息
- **日志保留**: 本地保留最近 100 条日志

### 告警配置

#### 性能告警
- **API 响应时间告警**: 响应时间 > 2 秒
- **数据库操作告警**: 操作时间 > 1 秒
- **错误率告警**: 错误率 > 5%

#### 安全告警
- **登录失败告警**: 短时间内多次登录失败
- **异常访问告警**: 来自异常 IP 的访问
- **数据异常告警**: 异常数据操作

## 运维操作

### 日常监控

#### 系统状态检查
```bash
# 检查系统状态
curl -X GET https://www.jiangxijiudian.store/api/test-connection

# 检查数据库连接
curl -X GET https://www.jiangxijiudian.store/api/db-status

# 检查应用健康
curl -X GET https://www.jiangxijiudian.store/api/health
```

#### 性能指标检查
- 定期检查 API 响应时间
- 监控数据库操作性能
- 检查错误日志

### 维护任务

#### 数据备份
- **自动备份**: 数据库自动备份（由 Neon 提供）
- **手动备份**: 定期执行数据快照
```bash
# 创建数据快照
curl -X POST https://www.jiangxijiudian.store/api/snapshot
```

#### 日志轮转
- 定期清理旧日志
- 检查日志大小
- 导出重要日志进行分析

#### 数据库维护
- 定期检查数据库性能
- 清理临时数据
- 优化数据库索引

### 故障处理

#### 常见故障类型

##### 数据库连接故障
**症状**:
- API 响应缓慢或超时
- 数据库操作失败
- 连接池耗尽

**处理步骤**:
1. 检查数据库连接字符串配置
2. 验证数据库服务状态
3. 检查连接池配置
4. 重启应用服务

##### API 性能问题
**症状**:
- API 响应时间超过阈值
- 用户体验下降
- 超时错误增加

**处理步骤**:
1. 检查慢查询日志
2. 分析性能监控数据
3. 优化数据库查询
4. 调整缓存策略

##### 认证问题
**症状**:
- 用户无法登录
- 认证失败错误
- 权限问题

**处理步骤**:
1. 检查管理员账户配置
2. 验证密码哈希
3. 确认认证流程
4. 检查会话管理

#### 故障诊断工具

##### 性能分析
```bash
# 检查 API 性能
curl -w "Total: %{time_total}s Connect: %{time_connect}s TTFB: %{time_starttransfer}s\n" \
     -X GET https://www.jiangxijiudian.store/api/orders
```

##### 日志分析
```bash
# 检查最近的错误日志
# 通过监控服务获取日志
# services/monitoring.ts 提供日志缓冲区访问
```

### 性能优化

#### 缓存策略
- **前端缓存**: 5 分钟缓存所有数据
- **API 缓存**: 合理设置响应缓存
- **数据库缓存**: 优化查询结果缓存

#### 数据库优化
- **查询优化**: 使用索引优化查询
- **连接池优化**: 调整连接池大小
- **数据分区**: 大表数据分区管理

#### 前端优化
- **CDN 优化**: 优化依赖加载
- **代码分割**: 按需加载组件
- **资源压缩**: 优化资源大小

## 安全维护

### 访问控制
- **API 访问**: 限制到正式域名
- **管理后台**: 仅允许授权访问
- **数据访问**: 实施权限控制

### 数据安全
- **敏感数据脱敏**: 自动脱敏处理
- **数据加密**: 传输加密
- **备份安全**: 加密数据备份

### 安全监控
- **异常登录**: 监控异常登录尝试
- **数据变更**: 监控重要数据变更
- **权限变更**: 监控权限修改操作

## 备份和恢复

### 数据备份策略
- **自动备份**: Neon 数据库自动备份
- **手动备份**: 定期手动创建快照
- **配置备份**: 备份环境配置

### 灾难恢复
- **数据库恢复**: 从 Neon 备份恢复
- **应用恢复**: 从版本控制恢复
- **配置恢复**: 从备份恢复配置

## 升级和维护窗口

### 计划维护
- **维护时间**: 选择业务低峰期
- **通知用户**: 提前通知系统维护
- **回滚计划**: 准备回滚方案

### 版本升级
- **测试环境验证**: 升级前在测试环境验证
- **灰度发布**: 逐步推广新版本
- **监控升级**: 升级后密切监控

## 联系和支持

### 技术支持
- **紧急联系**: 系统故障时的紧急联系方式
- **技术支持**: 日常技术问题支持
- **文档更新**: 维护文档更新

### 监控仪表板
- **实时监控**: 配置实时监控仪表板
- **告警通知**: 设置告警通知渠道
- **性能报告**: 定期生成性能报告