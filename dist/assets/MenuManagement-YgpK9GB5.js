import{jsx as t,jsxs as a}from"react/jsx-runtime";import{useState as n,useEffect as W,useMemo as Y}from"react";import{Loader2 as Z,Layers as ee,Plus as te,Search as ae,Edit2 as P,Trash2 as M,Utensils as le,X as g,Check as T}from"lucide-react";import{a as h}from"./auditLogger-DYWE_lBP.js";import{f as re}from"./index-Bha_CnxB.js";import{menuAPI as d}from"./menu-Dp2AkKIZ.js";import{I as se}from"./ImageLazyLoad-DPO3Dik5.js";import"react-dom/client";import"./database-sHUWp0Re.js";const ge=()=>{const[S,p]=n([]),[b,x]=n([]),[U,I]=n(!0),[q,o]=n(null),[$,k]=n(!1),[A,_]=n(!1),[f,E]=n(null),[v,O]=n(null),[m,H]=n(""),[N,K]=n("all"),[i,y]=n({name:"",name_en:"",category:"",price:0,active:!0,description:"",image:"",ingredients:[],tags:[]}),[c,w]=n({name:"",name_en:"",description:"",sortOrder:0,active:!0});W(()=>{R()},[]);const R=async()=>{try{I(!0);const[e,l]=await Promise.all([d.getDishes(),d.getCategories()]);p(e),x(l)}catch(e){console.error("Failed to load menu data:",e),o("Failed to load menu data")}finally{I(!1)}},u=e=>{const{name:l,value:r,type:s}=e.target,j=s==="number"?Number(r):s==="checkbox"?e.target.checked:r;y(L=>({...L,[l]:j}))},C=e=>{const{name:l,value:r,type:s}=e.target,j=s==="number"?Number(r):s==="checkbox"?e.target.checked:r;w(L=>({...L,[l]:j}))},X=async e=>{e.preventDefault();try{if(f){const l=await d.updateDish(f.id,i);p(r=>r.map(s=>s.id===f.id?l:s)),h.log("dish_updated",{dishId:l.id,user:"current_user"})}else{const l=await d.createDish(i);p(r=>[...r,l]),h.log("dish_created",{dishId:l.id,user:"current_user"})}D()}catch(l){console.error("Failed to save dish:",l),o("Failed to save dish")}},B=async e=>{e.preventDefault();try{if(v){const l=await d.updateCategory(v.id,c);x(r=>r.map(s=>s.id===v.id?l:s)),h.log("category_updated",{categoryId:l.id,user:"current_user"})}else{const l=await d.createCategory(c);x(r=>[...r,l]),h.log("category_created",{categoryId:l.id,user:"current_user"})}F()}catch(l){console.error("Failed to save category:",l),o("Failed to save category")}},G=e=>{E(e),y({name:e.name,name_en:e.name_en||"",category:e.category,price:e.price,active:e.active,description:e.description||"",image:e.image||"",ingredients:e.ingredients||[],tags:e.tags||[]}),k(!0)},J=e=>{O(e),w({name:e.name,name_en:e.name_en,description:e.description||"",sortOrder:e.sortOrder,active:e.active}),_(!0)},Q=async e=>{if(window.confirm("确定要删除这道菜吗？"))try{await d.deleteDish(e)&&(p(r=>r.filter(s=>s.id!==e)),h.log("dish_deleted",{dishId:e,user:"current_user"}))}catch(l){console.error("Failed to delete dish:",l),o("Failed to delete dish")}},V=async e=>{if(window.confirm("确定要删除这个分类吗？"))try{await d.deleteCategory(e)&&(x(r=>r.filter(s=>s.id!==e)),p(r=>r.map(s=>s.category===e?{...s,category:"未分类"}:s)),h.log("category_deleted",{categoryId:e,user:"current_user"}))}catch(l){console.error("Failed to delete category:",l),o("Failed to delete category")}},D=()=>{y({name:"",name_en:"",category:"",price:0,active:!0,description:"",image:"",ingredients:[],tags:[]}),E(null),k(!1)},F=()=>{w({name:"",name_en:"",description:"",sortOrder:0,active:!0}),O(null),_(!1)},z=Y(()=>S.filter(e=>{const l=!m||e.name.toLowerCase().includes(m.toLowerCase())||e.name_en.toLowerCase().includes(m.toLowerCase())||e.description&&e.description.toLowerCase().includes(m.toLowerCase()),r=N==="all"||e.category===N;return l&&r}),[S,m,N]);return U?t("div",{className:"flex items-center justify-center p-8",children:t(Z,{className:"h-8 w-8 animate-spin text-blue-600"})}):a("div",{className:"space-y-6",children:[a("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[a("div",{children:[t("h1",{className:"text-2xl font-bold text-slate-900",children:"菜单管理"}),t("p",{className:"text-slate-600",children:"管理菜品和分类"})]}),a("div",{className:"mt-4 flex gap-2 sm:mt-0",children:[a("button",{onClick:()=>_(!0),className:"flex items-center gap-2 rounded bg-green-600 px-4 py-2 text-white hover:bg-green-700",children:[t(ee,{size:18}),"添加分类"]}),a("button",{onClick:()=>k(!0),className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:[t(te,{size:18}),"添加菜品"]})]})]}),t("div",{className:"rounded-lg bg-white p-4 shadow",children:a("div",{className:"flex flex-col gap-4 md:flex-row",children:[a("div",{className:"relative flex-1",children:[t(ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:18}),t("input",{type:"text",placeholder:"搜索菜品...",value:m,onChange:e=>H(e.target.value),className:"w-full rounded-lg border border-slate-300 pl-10 pr-4 py-2"})]}),t("div",{className:"flex items-center gap-2",children:a("select",{value:N,onChange:e=>K(e.target.value),className:"rounded border border-slate-300 px-3 py-2",children:[t("option",{value:"all",children:"所有分类"}),b.map(e=>t("option",{value:e.name,children:e.name},e.id))]})})]})}),a("div",{className:"rounded-lg bg-white p-6 shadow",children:[a("div",{className:"mb-4 flex items-center justify-between",children:[t("h2",{className:"text-xl font-bold text-slate-900",children:"菜品分类"}),a("span",{className:"text-sm text-slate-600",children:[b.length," 个分类"]})]}),t("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3",children:b.map(e=>t("div",{className:"rounded-lg border border-slate-200 p-4",children:a("div",{className:"flex items-start justify-between",children:[a("div",{className:"flex-1",children:[t("h3",{className:"font-semibold",children:e.name}),t("p",{className:"text-sm text-slate-600",children:e.name_en}),e.description&&t("p",{className:"mt-1 text-sm text-slate-500",children:e.description}),a("div",{className:"mt-2 flex items-center gap-2",children:[t("span",{className:`text-xs px-2 py-1 rounded ${e.active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:e.active?"启用":"禁用"}),a("span",{className:"text-xs text-slate-500",children:["排序: ",e.sortOrder]})]})]}),a("div",{className:"flex gap-1",children:[t("button",{onClick:()=>J(e),className:"rounded bg-blue-100 p-1 text-blue-700 hover:bg-blue-200",children:t(P,{size:16})}),t("button",{onClick:()=>V(e.id),className:"rounded bg-red-100 p-1 text-red-700 hover:bg-red-200",children:t(M,{size:16})})]})]})},e.id))})]}),a("div",{className:"rounded-lg bg-white p-6 shadow",children:[a("div",{className:"mb-4 flex items-center justify-between",children:[t("h2",{className:"text-xl font-bold text-slate-900",children:"菜品列表"}),a("span",{className:"text-sm text-slate-600",children:[z.length," 道菜品"]})]}),z.length>0?t("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3",children:z.map(e=>t("div",{className:"rounded-lg border border-slate-200 p-4",children:a("div",{className:"flex items-start gap-4",children:[e.image?t("div",{className:"h-16 w-16 flex-shrink-0 rounded-md bg-slate-100",children:t(se,{src:e.image,alt:e.name,className:"h-full w-full rounded-md object-cover"})}):t("div",{className:"flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-md bg-slate-100",children:t(le,{size:24,className:"text-slate-400"})}),a("div",{className:"flex-1",children:[a("div",{className:"flex items-start justify-between",children:[a("div",{children:[t("h3",{className:"font-semibold",children:e.name}),t("p",{className:"text-sm text-slate-600",children:e.name_en})]}),a("div",{className:"flex gap-1",children:[t("button",{onClick:()=>G(e),className:"rounded bg-blue-100 p-1 text-blue-700 hover:bg-blue-200",children:t(P,{size:16})}),t("button",{onClick:()=>Q(e.id),className:"rounded bg-red-100 p-1 text-red-700 hover:bg-red-200",children:t(M,{size:16})})]})]}),a("div",{className:"mt-2",children:[t("p",{className:"text-lg font-bold text-green-700",children:re(e.price,"PHP")}),e.description&&t("p",{className:"mt-1 text-sm text-slate-600",children:e.description}),a("div",{className:"mt-2 flex flex-wrap gap-1",children:[t("span",{className:`text-xs px-2 py-1 rounded ${e.active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:e.active?"上架":"下架"}),t("span",{className:"text-xs bg-slate-100 text-slate-800 px-2 py-1 rounded",children:e.category})]})]})]})]})},e.id))}):t("div",{className:"py-8 text-center text-slate-500",children:"没有找到匹配的菜品"})]}),$&&t("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:a("div",{className:"w-full max-w-2xl rounded-lg bg-white p-6",children:[a("div",{className:"mb-4 flex items-center justify-between",children:[t("h3",{className:"text-xl font-bold text-slate-900",children:f?"编辑菜品":"添加菜品"}),t("button",{onClick:D,className:"rounded-full p-1 hover:bg-slate-100",children:t(g,{size:20})})]}),a("form",{onSubmit:X,className:"space-y-4",children:[a("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"中文名称"}),t("input",{type:"text",name:"name",value:i.name,onChange:u,required:!0,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"如: 宫保鸡丁"})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"英文名称"}),t("input",{type:"text",name:"name_en",value:i.name_en,onChange:u,required:!0,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"如: Kung Pao Chicken"})]})]}),a("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"价格"}),t("input",{type:"number",name:"price",value:i.price,onChange:u,required:!0,min:"0",step:"0.01",className:"w-full rounded border border-slate-300 px-3 py-2"})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"分类"}),a("select",{name:"category",value:i.category,onChange:u,required:!0,className:"w-full rounded border border-slate-300 px-3 py-2",children:[t("option",{value:"",children:"选择分类"}),b.map(e=>t("option",{value:e.name,children:e.name},e.id))]})]})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"描述"}),t("textarea",{name:"description",value:i.description,onChange:u,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"菜品描述...",rows:2})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"图片链接"}),t("input",{type:"text",name:"image",value:i.image,onChange:u,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"图片URL..."})]}),a("div",{className:"flex items-center gap-2",children:[t("input",{type:"checkbox",name:"active",id:"dish-active",checked:i.active,onChange:e=>y(l=>({...l,active:e.target.checked})),className:"rounded border-slate-300"}),t("label",{htmlFor:"dish-active",className:"text-sm font-medium text-slate-700",children:"上架状态"})]}),a("div",{className:"flex gap-2",children:[a("button",{type:"submit",className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:[t(T,{size:18}),"保存"]}),a("button",{type:"button",onClick:D,className:"flex items-center gap-2 rounded border border-slate-300 px-4 py-2 hover:bg-slate-50",children:[t(g,{size:18}),"取消"]})]})]})]})}),A&&t("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:a("div",{className:"w-full max-w-md rounded-lg bg-white p-6",children:[a("div",{className:"mb-4 flex items-center justify-between",children:[t("h3",{className:"text-xl font-bold text-slate-900",children:v?"编辑分类":"添加分类"}),t("button",{onClick:F,className:"rounded-full p-1 hover:bg-slate-100",children:t(g,{size:20})})]}),a("form",{onSubmit:B,className:"space-y-4",children:[a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"中文名称"}),t("input",{type:"text",name:"name",value:c.name,onChange:C,required:!0,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"如: 主食"})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"英文名称"}),t("input",{type:"text",name:"name_en",value:c.name_en,onChange:C,required:!0,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"如: Staple Food"})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"描述"}),t("textarea",{name:"description",value:c.description,onChange:C,className:"w-full rounded border border-slate-300 px-3 py-2",placeholder:"分类描述...",rows:2})]}),a("div",{className:"grid grid-cols-2 gap-4",children:[a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"排序"}),t("input",{type:"number",name:"sortOrder",value:c.sortOrder,onChange:C,required:!0,min:"0",className:"w-full rounded border border-slate-300 px-3 py-2"})]}),a("div",{children:[t("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"状态"}),a("select",{name:"active",value:c.active.toString(),onChange:e=>w(l=>({...l,active:e.target.value==="true"})),className:"w-full rounded border border-slate-300 px-3 py-2",children:[t("option",{value:"true",children:"启用"}),t("option",{value:"false",children:"禁用"})]})]})]}),a("div",{className:"flex gap-2",children:[a("button",{type:"submit",className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:[t(T,{size:18}),"保存"]}),a("button",{type:"button",onClick:F,className:"flex items-center gap-2 rounded border border-slate-300 px-4 py-2 hover:bg-slate-50",children:[t(g,{size:18}),"取消"]})]})]})]})}),q&&a("div",{className:"fixed bottom-4 right-4 rounded-lg bg-red-50 p-4 text-red-700 shadow-lg",children:[q,t("button",{onClick:()=>o(null),className:"ml-2 rounded-full p-1 hover:bg-red-100",children:t(g,{size:16})})]})]})};export{ge as default};
