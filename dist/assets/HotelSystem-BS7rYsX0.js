import{jsxs as a,jsx as t,Fragment as I}from"react/jsx-runtime";import{useState as c,useEffect as de}from"react";import{X as O,Receipt as K,Loader2 as R,Utensils as z,User as ce,ChefHat as me,CreditCard as U,Plus as ue}from"lucide-react";import{t as l,O as p,f as g,a as N}from"./index-Bha_CnxB.js";import{I as be}from"./ImageLazyLoad-DPO3Dik5.js";import{a as V}from"./auditLogger-DYWE_lBP.js";import"react-dom/client";const ve=({dishes:Y,orders:k=[],onPlaceOrder:j})=>{const[w,D]=c(2),[X,_]=c([]),[n,B]=c(null),[J,q]=c(!1),[b,v]=c([]),[A,T]=c(!1),[Q,H]=c("加载中..."),[E,f]=c(null),[F,y]=c(null),[W,$]=c([]),[Z,C]=c(!1),[u,G]=c(null),[L,M]=c(!1);de(()=>{(async()=>{try{const r=await N.fetchCollection("hotel_rooms"),o=[];for(let d=1;d<=32;d++){const h=`82${d.toString().padStart(2,"0")}`,x=r.find(P=>P.roomNumber===h);x?o.push({...x,status:"vacant"}):o.push({id:`room-${h}`,roomNumber:h,floor:2,status:"vacant",type:"standard",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}for(let d=1;d<=32;d++){const h=`83${d.toString().padStart(2,"0")}`,x=r.find(P=>P.roomNumber===h);x?o.push({...x,status:"vacant"}):o.push({id:`room-${h}`,roomNumber:h,floor:3,status:"vacant",type:"standard",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}const s=[{id:"vip-mudan",roomNumber:"牡丹",floor:4,status:"vacant",type:"dining-vip",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"vip-lianhua",roomNumber:"莲花",floor:4,status:"vacant",type:"dining-vip",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"vip-xingguang",roomNumber:"星光",floor:4,status:"vacant",type:"ktv",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],i=[...o,...s];_(i);const m=await N.fetchCollection("partner_accounts");$(m)}catch(r){console.error("获取数据失败:",r),f("获取数据失败");const o=[];for(let m=1;m<=32;m++){const d=`82${m.toString().padStart(2,"0")}`;o.push({id:`room-${d}`,roomNumber:d,floor:2,status:"vacant",type:"standard",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}for(let m=1;m<=32;m++){const d=`83${m.toString().padStart(2,"0")}`;o.push({id:`room-${d}`,roomNumber:d,floor:3,status:"vacant",type:"standard",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}const s=[{id:"vip-mudan",roomNumber:"牡丹",floor:4,status:"vacant",type:"dining-vip",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"vip-lianhua",roomNumber:"莲花",floor:4,status:"vacant",type:"dining-vip",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"vip-xingguang",roomNumber:"星光",floor:4,status:"vacant",type:"ktv",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],i=[...o,...s];_(i),$([])}})()},[]);const ee=X.filter(e=>e.floor===w),te=e=>{v(r=>r.find(s=>s.dishId===e.id)?r.map(s=>s.dishId===e.id?{...s,quantity:s.quantity+1}:s):[...r,{id:e.id,dishId:e.id,name:e.name,quantity:1,price:e.price}])},ae=e=>{v(r=>{const o=r.find(s=>s.dishId===e);return o&&o.quantity>1?r.map(s=>s.dishId===e?{...s,quantity:s.quantity-1}:s):r.filter(s=>s.dishId!==e)})},S=b.reduce((e,r)=>e+r.price*r.quantity,0),se=0,re=[...ee].sort((e,r)=>{const o=parseInt(e.roomNumber.replace(/\D/g,""))||0,s=parseInt(r.roomNumber.replace(/\D/g,""))||0;return o-s}),oe=e=>{B(e),q(!0)},le=()=>{n&&alert("此系统专为客房送餐服务设计，房间占用状态不影响点餐功能。")},ne=async()=>{if(!(!n||b.length===0||!u)){M(!0),H(l("正在处理挂账...")),f(null);try{const e={id:`ORD-${Date.now()}`,tableId:n.roomNumber,items:b,status:p.PENDING,total:b.reduce((o,s)=>o+s.price*s.quantity,0),paid:!1,timestamp:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),roomNumber:n.roomNumber,paymentMethod:`挂账-${u.name_en}`};await N.create("orders",e),j(e);const r={...u,current_balance:u.current_balance+e.total,updatedAt:new Date().toISOString()};await N.update("partner_accounts",u.id,r),$(o=>o.map(s=>s.id===u.id?r:s)),V.log("info","CHARGE_TO_ACCOUNT",`${l("挂账订单")}: ${u.name_cn} - ₱${e.total}`,"staff"),y(`${l("挂账成功！")}!
${l("单位")}: ${u.name_cn}
${l("金额")}: ₱${e.total}`),v([]),G(null),C(!1),setTimeout(()=>y(null),3e3)}catch(e){console.error("Failed to charge to account:",e),f(`${l("挂账失败，请重试。")}`)}finally{M(!1)}}},ie=async()=>{if(!(!n||b.length===0)){T(!0),H(l("正在提交订单...")),f(null);try{const e={id:`ORD-${Date.now()}`,tableId:n.roomNumber,items:b,status:p.PENDING,total:b.reduce((r,o)=>r+o.price*o.quantity,0),paid:!1,timestamp:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),roomNumber:n.roomNumber};await N.create("orders",e),j(e),V.log("info","ROOM_ORDER",`${l("客房点餐")}: ${n.roomNumber} - ₱${e.total}`,"admin"),y(`${l("订单已发送至厨房！")}!
${l("房号")}: ${n.roomNumber}`),v([]),setTimeout(()=>y(null),3e3)}catch(e){console.error("Failed to submit order:",e),f(`${l("订单提交失败，请重试。")} ${l("Order submission failed, please try again.")}`)}finally{T(!1)}}};return a("div",{className:"relative mx-auto min-h-screen max-w-md overflow-hidden bg-slate-50 pb-24 font-sans shadow-2xl",children:[E&&t("div",{className:"fixed left-1/2 top-4 z-50 -translate-x-1/2 transform rounded-lg border border-red-200 bg-red-50 px-6 py-3 text-red-700 shadow-lg",children:a("div",{className:"flex items-center gap-2",children:[t(O,{size:18}),t("span",{className:"font-medium",children:E})]})}),F&&t("div",{className:"fixed left-1/2 top-4 z-50 -translate-x-1/2 transform rounded-lg border border-green-200 bg-green-50 px-6 py-3 text-green-700 shadow-lg",children:a("div",{className:"flex items-center gap-2",children:[t(K,{size:18}),t("span",{className:"font-medium",children:F})]})}),A&&t("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30",children:a("div",{className:"flex flex-col items-center gap-3 rounded-xl bg-white p-6 shadow-2xl",children:[t(R,{className:"animate-spin text-orange-600",size:32}),t("p",{className:"font-medium text-slate-700",children:Q})]})}),a("div",{className:"flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center",children:[a("div",{children:[a("h2",{className:"flex items-center gap-2 text-2xl font-bold text-slate-800",children:[t(z,{className:"text-orange-500"})," ",l("hotel"),"服务"]}),t("p",{className:"mt-1 text-sm text-slate-500",children:l("为客房下单，订单将自动流转至后厨")}),t("p",{className:"mt-1 text-xs text-slate-500",children:l("房间号范围: 8201-8232 (2楼) 和 8301-8332 (3楼)")})]}),a("div",{className:"flex rounded-lg border border-slate-200 bg-white p-1 shadow-sm",children:[t("button",{onClick:()=>D(2),className:`rounded-md px-3 py-2 text-sm font-bold transition-all ${w===2?"bg-orange-500 text-white shadow-sm":"text-slate-500 hover:bg-slate-50"}`,children:"2F (82xx)"}),t("button",{onClick:()=>D(3),className:`rounded-md px-3 py-2 text-sm font-bold transition-all ${w===3?"bg-orange-500 text-white shadow-sm":"text-slate-500 hover:bg-slate-50"}`,children:"3F (83xx)"}),t("button",{onClick:()=>D(4),className:`rounded-md px-3 py-2 text-sm font-bold transition-all ${w===4?"bg-purple-500 text-white shadow-sm":"text-slate-500 hover:bg-slate-50"}`,children:"4F (KTV/VIP)"})]})]}),t("div",{className:"grid grid-cols-4 gap-3 sm:grid-cols-6 md:grid-cols-8",children:re.map(e=>{const r=k.some(i=>i.roomNumber===e.roomNumber&&(i.status===p.PENDING||i.status===p.COOKING||i.status===p.READY));let o="",s=null;return e.type==="dining-vip"?(o=r?"bg-rose-200 border-rose-500 text-rose-900":"bg-rose-100 border-rose-400 text-rose-900",s=t(z,{size:16,className:"text-rose-600"})):o=r?"border-orange-500 bg-orange-50 text-orange-900 shadow-md":"border-slate-200 bg-white text-slate-400 hover:border-orange-300",a("button",{onClick:()=>oe(e),className:`
                relative flex aspect-square flex-col items-center justify-center rounded-xl border-2 p-2 transition-all
                ${o}
              `,children:[e.type==="dining-vip"&&s,t("span",{className:"text-lg font-bold",children:e.type==="standard"?`${l("Kuwarto")} ${e.roomNumber}`:e.roomNumber}),r&&a("div",{className:"mt-1 flex items-center gap-1 rounded-full bg-white/50 px-2 py-0.5 text-xs font-bold",children:[t(z,{size:10}),a("span",{children:["₱",k.filter(i=>i.roomNumber===e.roomNumber&&(i.status===p.PENDING||i.status===p.COOKING||i.status===p.READY)).reduce((i,m)=>i+m.total,0).toFixed(2)]})]})]},e.id)})}),J&&n&&t("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:a("div",{className:"flex max-h-[90vh] w-full max-w-5xl flex-col overflow-hidden rounded-2xl bg-white",children:[a("div",{className:"flex items-center justify-between border-b border-slate-100 bg-slate-50 p-4",children:[t("div",{children:a("h3",{className:"flex items-center gap-2 text-xl font-bold text-slate-800",children:[n.type==="vip"?n.roomNumber:`${l("Kuwarto")} ${n.roomNumber}`,t("span",{className:`rounded border px-2 py-0.5 text-xs ${n.status==="occupied"?"border-blue-200 bg-blue-100 text-blue-700":"border-slate-200 bg-slate-100 text-slate-500"}`,children:n.status==="occupied"?l("Occupied"):l("Vacant")})]})}),t("button",{onClick:()=>q(!1),className:"p-2 text-slate-400 hover:text-slate-600",children:t(O,{size:24})})]}),a("div",{className:"flex flex-1 flex-col overflow-hidden md:flex-row",children:[a("div",{className:"flex w-full flex-col border-r border-slate-100 bg-white md:w-1/3",children:[t("div",{className:"border-b border-slate-100 p-4",children:a("button",{onClick:le,className:`flex w-full items-center justify-center gap-2 rounded-lg border py-2 text-sm font-bold transition-colors ${n.status==="occupied"?"border-slate-300 bg-white text-slate-600 hover:bg-slate-50":"border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-100"}`,children:[t(ce,{size:16}),"房间状态说明"]})}),a("div",{className:"flex-1 overflow-y-auto bg-orange-50/30 p-4",children:[a("h4",{className:"mb-3 flex items-center gap-2 text-sm font-bold text-slate-800",children:[t(me,{size:16})," New Order (待提交)"]}),b.length===0?t("div",{className:"rounded-lg border border-dashed border-slate-300 py-4 text-center text-xs text-slate-400",children:"Select items from menu"}):t("div",{className:"space-y-2",children:b.map((e,r)=>a("div",{className:"flex items-center justify-between rounded bg-white p-2 text-sm shadow-sm",children:[a("div",{children:[t("div",{className:"font-medium text-slate-800",children:e.name}),a("div",{className:"text-xs text-orange-600",children:[g(e.price,"PHP")," x ",e.quantity]})]}),a("div",{className:"flex items-center gap-2",children:[t("span",{className:"font-bold",children:g(e.price*e.quantity,"PHP")}),t("button",{onClick:()=>ae(e.dishId),className:"text-slate-400 hover:text-red-500",children:t(O,{size:14})})]})]},r))})]}),t("div",{className:"border-t border-slate-100 bg-slate-50 p-4",children:a("h4",{className:"mb-2 flex justify-between text-xs font-bold uppercase text-slate-500",children:[t("span",{children:"历史订单总额"}),t("span",{children:g(se,"PHP")})]})}),a("div",{className:"z-10 border-t border-slate-100 bg-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.05)]",children:[a("div",{className:"mb-4 flex items-center justify-between",children:[t("span",{className:"font-medium text-slate-600",children:"Cart Total"}),t("span",{className:"text-2xl font-bold text-orange-600",children:g(S,"PHP")})]}),Z&&a("div",{className:"mb-4 rounded-lg border border-slate-200 bg-slate-50 p-4",children:[a("div",{className:"mb-3 flex items-center justify-between",children:[t("h4",{className:"font-bold text-slate-800",children:l("选择挂账单位")}),t("button",{onClick:()=>C(!1),className:"text-slate-500 hover:text-slate-700",children:t(O,{size:18})})]}),t("div",{className:"max-h-40 overflow-y-auto",children:W.map(e=>a("div",{onClick:()=>G(e),className:`mb-2 cursor-pointer rounded-lg border p-3 transition-colors ${u?.id===e.id?"border-orange-500 bg-orange-50":"border-slate-200 hover:bg-slate-100"}`,children:[t("div",{className:"font-medium text-slate-800",children:e.name_en}),t("div",{className:"text-sm text-slate-600",children:e.name_cn}),a("div",{className:"text-xs text-slate-500",children:[l("当前欠款"),": ",g(e.current_balance,"PHP")," / ",g(e.credit_limit,"PHP")]})]},e.id))}),u&&t("button",{onClick:ne,disabled:L,className:"mt-3 w-full rounded-lg bg-red-600 px-4 py-2 font-bold text-white hover:bg-red-700 disabled:opacity-50",children:L?a(I,{children:[t(R,{className:"mr-2 inline animate-spin",size:16}),l("处理中...")]}):a(I,{children:[t(U,{className:"mr-2 inline",size:16}),l("确认挂账")," - ",g(S,"PHP")]})})]}),a("div",{className:"space-y-2",children:[t("button",{onClick:ie,disabled:S===0||A,className:"flex w-full items-center justify-center gap-2 rounded-xl bg-orange-600 py-3 font-bold text-white shadow-lg shadow-orange-200 hover:bg-orange-700 disabled:cursor-not-allowed disabled:opacity-50",children:A?a(I,{children:[t(R,{className:"animate-spin",size:18}),l("提交中...")]}):a(I,{children:[t(K,{size:18})," ",l("Send to Kitchen")]})}),a("button",{onClick:()=>C(!0),disabled:S===0,className:"flex w-full items-center justify-center gap-2 rounded-xl bg-red-600 py-2 font-bold text-white shadow-lg shadow-red-200 hover:bg-red-700 disabled:cursor-not-allowed disabled:opacity-50",children:[t(U,{size:16})," ",l("挂账")]})]})]})]}),a("div",{className:"flex-1 overflow-y-auto bg-white p-4",children:[t("div",{className:"mb-4",children:t("h4",{className:"font-bold text-slate-800",children:"Menu 菜单"})}),t("div",{className:"grid grid-cols-2 gap-3 md:grid-cols-3 lg:grid-cols-4",children:Y.map(e=>a("button",{onClick:()=>te(e),className:"group flex h-full flex-col rounded-xl border border-slate-200 bg-white p-3 text-left shadow-sm transition-all hover:border-orange-400 hover:shadow-md",children:[a("div",{className:"relative mb-2 aspect-video shrink-0 overflow-hidden rounded-lg bg-slate-100",children:[t(be,{src:e.image||"/placeholder-image.jpg",alt:e.name,className:"h-full w-full object-cover"}),t("div",{className:"absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 transition-opacity group-hover:opacity-100",children:t(ue,{className:"text-white drop-shadow-md",size:24})})]}),a("div",{className:"flex flex-1 flex-col justify-between",children:[t("div",{className:"line-clamp-1 text-sm font-bold text-slate-800",children:e.name}),t("div",{className:"mt-1 text-sm font-bold text-orange-600",children:g(e.price,"PHP")})]})]},e.id))})]})]})]})})]})};export{ve as default};
