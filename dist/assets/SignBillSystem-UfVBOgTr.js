import{jsxs as a,jsx as t}from"react/jsx-runtime";import{useState as c}from"react";import{FileSignature as T,Plus as j,Search as H,Edit2 as _,UserCheck as $,Phone as E,ArrowDownRight as F,HandCoins as B,X as P}from"lucide-react";import{a as x}from"./index-CHj5k0ei.js";import"react-dom/client";const X=({accounts:p,setAccounts:g})=>{const[f,k]=c(""),[A,h]=c(!1),[n,v]=c(null),[o,u]=c({isOpen:!1,type:"charge",accountId:null}),[b,w]=c(""),[y,D]=c("CASH"),[s,m]=c({name:"",cooperationMethod:"协议单位",settlementMethod:"月结",approver:"",phoneNumber:"",creditLimit:0,currentDebt:0,status:"Active"}),L=p.reduce((e,l)=>e+(l.status==="Active"?l.currentDebt:0),0),O=p.filter(e=>e.name?.toLowerCase().includes(f.toLowerCase())||e.approver?.toLowerCase().includes(f.toLowerCase())),C=e=>{e?(v(e),m(e)):(v(null),m({name:"",cooperationMethod:"协议单位",settlementMethod:"月结",approver:"",phoneNumber:"",creditLimit:0,currentDebt:0,status:"Active"})),h(!0)},z=async e=>{e.preventDefault();try{if(n){const l={...n,...s,name:s.name||n.name,cooperationMethod:s.cooperationMethod||n.cooperationMethod,settlementMethod:s.settlementMethod||n.settlementMethod,approver:s.approver||n.approver,phoneNumber:s.phoneNumber||n.phoneNumber,creditLimit:s.creditLimit??n.creditLimit,currentDebt:s.currentDebt??n.currentDebt,status:s.status||n.status};await x.update("sign_bill_accounts",n.id,l),g(d=>d.map(i=>i.id===n.id?l:i))}else{const l={name:s.name||"",cooperationMethod:s.cooperationMethod||"协议单位",settlementMethod:s.settlementMethod||"月结",approver:s.approver||"",phoneNumber:s.phoneNumber||"",creditLimit:s.creditLimit||0,currentDebt:s.currentDebt||0,status:s.status||"Active",lastTransactionDate:new Date().toISOString()},i=await x.create("sign_bill_accounts",l);i.success&&i.data&&g(r=>[i.data,...r])}h(!1)}catch(l){console.error("保存账户失败:",l),alert("保存失败: "+(l instanceof Error?l.message:"未知错误"))}},I=async()=>{const e=parseFloat(b);if(isNaN(e)||e<=0){alert("请输入有效金额");return}const l=p.find(r=>r.id===o.accountId);if(!l)return;const d=o.type==="settle",i=d?Math.max(0,l.currentDebt-e):l.currentDebt+e;try{const r={...l,currentDebt:i,lastTransactionDate:new Date().toISOString()};await x.update("sign_bill_accounts",l.id,r);const S={category:d?"SignBillSettlement":"SignBillCharge",amount:e,description:`${d?"还款":"记账"} - ${l.name} (${l.id})`,date:new Date().toISOString(),timestamp:new Date().toISOString(),accountId:l.id,accountName:l.name,transactionType:o.type,paymentMethod:d?y:null,previousDebt:l.currentDebt,newDebt:i};try{await x.create("expenses",S),console.log("交易记录已保存:",S)}catch(N){console.error("保存交易记录失败:",N)}g(N=>N.map(M=>M.id===l.id?r:M)),u({...o,isOpen:!1}),w(""),D("CASH")}catch(r){console.error("交易失败:",r),alert("操作失败: "+(r instanceof Error?r.message:"未知错误"))}};return a("div",{className:"p-6 space-y-6",children:[a("div",{className:"flex justify-between items-center",children:[a("h2",{className:"text-2xl font-bold flex items-center gap-2 text-slate-800",children:[t(T,{className:"text-indigo-600"})," 财务签单系统"]}),a("button",{onClick:()=>C(),className:"bg-indigo-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-indigo-700 transition-all",children:[t(j,{size:18})," 新增账户"]})]}),a("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a("div",{className:"bg-white p-6 rounded-2xl border border-slate-100 shadow-sm",children:[t("p",{className:"text-slate-500 text-sm font-medium",children:"挂账总额 Total Debt"}),a("h3",{className:"text-3xl font-black text-rose-600 mt-2",children:["₱ ",L.toLocaleString()]})]}),a("div",{className:"bg-white p-6 rounded-2xl border border-slate-100 shadow-sm",children:[t("p",{className:"text-slate-500 text-sm font-medium",children:"活跃单位 Active Units"}),t("h3",{className:"text-3xl font-black text-slate-800 mt-2",children:p.length})]})]}),a("div",{className:"relative",children:[t(H,{className:"absolute left-4 top-1/2 -translate-y-1/2 text-slate-400",size:18}),t("input",{type:"text",placeholder:"搜索单位、批准人...",className:"w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none",value:f,onChange:e=>k(e.target.value)})]}),t("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:O.map(e=>a("div",{className:"bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-all",children:[a("div",{className:"flex justify-between items-start mb-4",children:[a("div",{children:[t("h4",{className:"text-lg font-bold text-slate-800",children:e.name}),a("div",{className:"flex gap-2 mt-1",children:[t("span",{className:"text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md font-bold uppercase",children:e.cooperationMethod}),t("span",{className:"text-[10px] bg-slate-50 text-slate-500 px-2 py-0.5 rounded-md font-bold uppercase",children:e.settlementMethod})]})]}),t("button",{onClick:()=>C(e),className:"p-2 text-slate-400 hover:text-indigo-600 transition-colors",children:t(_,{size:16})})]}),a("div",{className:"space-y-2 mb-6 text-sm text-slate-600",children:[a("div",{className:"flex items-center gap-2",children:[t($,{size:14,className:"text-slate-400"})," 批准人: ",e.approver]}),a("div",{className:"flex items-center gap-2",children:[t(E,{size:14,className:"text-slate-400"})," 电话: ",e.phoneNumber]})]}),a("div",{className:"flex justify-between items-end pt-4 border-t border-slate-50",children:[a("div",{children:[t("p",{className:"text-[10px] text-slate-400 font-bold uppercase tracking-wider",children:"当前欠款 Current Debt"}),a("p",{className:`text-2xl font-black ${e.currentDebt>0?"text-rose-600":"text-emerald-600"}`,children:["₱ ",e.currentDebt.toLocaleString()]})]}),a("div",{className:"flex gap-2",children:[t("button",{onClick:()=>u({isOpen:!0,type:"charge",accountId:e.id}),className:"p-3 bg-rose-50 text-rose-600 rounded-xl hover:bg-rose-100 transition-colors",title:"记账",children:t(F,{size:20})}),t("button",{onClick:()=>u({isOpen:!0,type:"settle",accountId:e.id}),className:"p-3 bg-emerald-50 text-emerald-600 rounded-xl hover:bg-emerald-100 transition-colors",title:"还款",children:t(B,{size:20})})]})]})]},e.id))}),o.isOpen&&t("div",{className:"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4",children:a("div",{className:"bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in duration-300",children:[t("h3",{className:"text-xl font-black text-slate-800 text-center mb-2",children:o.type==="charge"?"记账 (Add Charge)":"还款 (Settle)"}),t("p",{className:"text-center text-slate-500 text-sm mb-8",children:"输入金额并确认方式"}),a("div",{className:"relative mb-6",children:[t("span",{className:"absolute left-6 top-1/2 -translate-y-1/2 text-2xl font-black text-slate-300",children:"₱"}),t("input",{type:"number",autoFocus:!0,placeholder:"0.00",className:"w-full pl-12 pr-6 py-5 bg-slate-50 rounded-2xl text-3xl font-black text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none text-center appearance-none",value:b,onChange:e=>w(e.target.value)})]}),o.type==="settle"&&t("div",{className:"grid grid-cols-3 gap-2 mb-8",children:["CASH","USDT","ALIPAY","WECHAT","GCASH","MAYA"].map(e=>t("button",{onClick:()=>D(e),className:`py-2 text-[9px] font-black rounded-lg border transition-all ${y===e?"bg-indigo-600 border-indigo-600 text-white shadow-lg":"bg-white border-slate-100 text-slate-400"}`,children:e},e))}),a("div",{className:"flex gap-4",children:[t("button",{onClick:()=>u({...o,isOpen:!1}),className:"flex-1 py-4 text-slate-500 font-bold hover:bg-slate-50 rounded-2xl transition-colors",children:"取消"}),t("button",{onClick:I,disabled:!b||parseFloat(b)<=0,className:`flex-1 py-4 rounded-2xl text-white font-black shadow-lg disabled:opacity-50 disabled:shadow-none transition-all ${o.type==="charge"?"bg-rose-600 shadow-rose-200":"bg-emerald-600 shadow-emerald-200"}`,children:"确认"})]})]})}),A&&t("div",{className:"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4",children:a("div",{className:"bg-white p-8 rounded-[2.5rem] w-full max-w-md shadow-2xl animate-in fade-in zoom-in duration-300",children:[a("div",{className:"flex justify-between items-center mb-6",children:[t("h3",{className:"text-xl font-bold text-slate-800",children:n?"编辑账户":"新增账户"}),t("button",{onClick:()=>h(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400",children:t(P,{size:20})})]}),a("form",{onSubmit:z,className:"space-y-4",children:[t("input",{placeholder:"名称",className:"w-full p-3 bg-slate-50 rounded-xl",value:s.name,onChange:e=>m({...s,name:e.target.value})}),t("input",{placeholder:"批准人",className:"w-full p-3 bg-slate-50 rounded-xl",value:s.approver,onChange:e=>m({...s,approver:e.target.value})}),t("input",{placeholder:"电话",className:"w-full p-3 bg-slate-50 rounded-xl",value:s.phoneNumber,onChange:e=>m({...s,phoneNumber:e.target.value})}),a("div",{className:"flex gap-4 pt-4",children:[t("button",{type:"button",onClick:()=>h(!1),className:"flex-1 font-bold text-slate-500",children:"取消"}),t("button",{type:"submit",className:"flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg",children:"保存账户"})]})]})]})})]})};export{X as default};
