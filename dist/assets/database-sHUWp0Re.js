class c{static instance;isProduction;logBuffer=[];maxBufferSize=100;constructor(){this.isProduction=!0}static getInstance(){return c.instance||(c.instance=new c),c.instance}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t,o){const r={...o,...t&&{errorName:t.name,errorMessage:t.message,errorStack:this.isProduction?void 0:t.stack,errorType:typeof t}};this.log("error",e,r)}debug(e,t){this.isProduction||this.log("debug",e,t)}recordApiPerformance(e,t,o){t>2e3?this.warn("Slow API response",{endpoint:e,duration:t,status:o,threshold:2e3}):this.debug("API response",{endpoint:e,duration:t,status:o})}recordDatabasePerformance(e,t,o){t>1e3?this.warn("Slow database operation",{operation:e,duration:t,collection:o,threshold:1e3}):this.debug("Database operation",{operation:e,duration:t,collection:o})}log(e,t,o){const r={timestamp:new Date().toISOString(),level:e,message:t,context:this.sanitizeContext(o),environment:this.isProduction?"production":"development"};this.logBuffer.push(r),this.logBuffer.length>this.maxBufferSize&&this.logBuffer.shift(),this.isProduction?(e==="error"||e==="warn")&&console[e](`[${e.toUpperCase()}] ${t}`,this.redactSensitiveData(r.context)):console[e](`[${e.toUpperCase()}] ${t}`,r.context),this.isProduction&&e==="error"&&this.sendErrorToRemoteService(r)}sanitizeContext(e){if(!e)return e;const t={};for(const[o,r]of Object.entries(e))t[o]=this.redactSensitiveData(r);return t}redactSensitiveData(e){if(e==null)return e;if(typeof e=="string")return this.isSensitiveField(e)?"[REDACTED]":e;if(typeof e=="object"&&!Array.isArray(e)){const t={};for(const[o,r]of Object.entries(e)){const n=this.isSensitiveField(o)?`${o}_redacted`:o;t[n]=this.redactSensitiveData(r)}return t}return Array.isArray(e)?e.map(t=>this.redactSensitiveData(t)):e}isSensitiveField(e){return[/password/i,/token/i,/secret/i,/key/i,/auth/i,/credential/i,/credit.*card/i,/card.*number/i,/cvv/i,/cvc/i,/ssn/i,/social.*security/i,/bank.*account/i,/routing.*number/i].some(o=>o.test(e))}sendErrorToRemoteService(e){console.error("Error Report:",{timestamp:e.timestamp,message:e.message,context:e.context})}getLogBuffer(){return[...this.logBuffer]}clearLogBuffer(){this.logBuffer=[]}}const i=c.getInstance();class m{store=new Map;async connect(){console.log("Memory database connected")}async disconnect(){console.log("Memory database disconnected")}async get(e){const t=Date.now();try{const o=this.store.get(e)||null,r=Date.now()-t;return i.recordDatabasePerformance("get",r,this.getEntityType(e)),o}catch(o){const r=Date.now()-t;throw i.error("Database get operation failed",o,{operation:"get",key:e,duration:r}),o}}async set(e,t){const o=Date.now();try{this.validateData(e,t),this.store.set(e,t);const r=Date.now()-o;i.recordDatabasePerformance("set",r,this.getEntityType(e))}catch(r){const n=Date.now()-o;throw i.error("Database set operation failed",r,{operation:"set",key:e,duration:n}),r}}async delete(e){const t=Date.now();try{const o=this.store.delete(e),r=Date.now()-t;return i.recordDatabasePerformance("delete",r,this.getEntityType(e)),o}catch(o){const r=Date.now()-t;throw i.error("Database delete operation failed",o,{operation:"delete",key:e,duration:r}),o}}async getAll(e){const t=Date.now();try{const o=[];for(const[n,a]of this.store.entries())n.startsWith(e)&&o.push(a);const r=Date.now()-t;return i.recordDatabasePerformance("getAll",r,this.getEntityType(e)),o}catch(o){const r=Date.now()-t;throw i.error("Database getAll operation failed",o,{operation:"getAll",prefix:e,duration:r}),o}}async create(e,t){const o=Date.now();try{const r=this.generateId(),n=new Date().toISOString(),a={...t,id:r,createdAt:n,updatedAt:n};this.validateData(`${e}:${r}`,a),await this.set(`${e}:${r}`,a);const s=Date.now()-o;return i.recordDatabasePerformance("create",s,e),a}catch(r){const n=Date.now()-o;throw i.error("Database create operation failed",r,{operation:"create",prefix:e,duration:n}),r}}async update(e,t,o){const r=Date.now();try{const n=`${e}:${t}`,a=await this.get(n);if(!a)return null;const s={...a,...o,updatedAt:new Date().toISOString()};this.validateData(n,s),await this.set(n,s);const w=Date.now()-r;return i.recordDatabasePerformance("update",w,e),s}catch(n){const a=Date.now()-r;throw i.error("Database update operation failed",n,{operation:"update",prefix:e,id:t,duration:a}),n}}async remove(e,t){const o=Date.now();try{const r=`${e}:${t}`,n=await this.delete(r),a=Date.now()-o;return i.recordDatabasePerformance("remove",a,e),n}catch(r){const n=Date.now()-o;throw i.error("Database remove operation failed",r,{operation:"remove",prefix:e,id:t,duration:n}),r}}generateId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}getEntityType(e){return e.split(":")[0]}validateData(e,t){switch(e.split(":")[0]){case"orders":if(t.total===void 0||t.total===null)throw new Error("订单逻辑错误：总额(total)不能为空");if(t.items===void 0||!Array.isArray(t.items))throw new Error("订单逻辑错误：订单项(items)必须为数组");if(t.tableId===void 0||t.tableId==="")throw new Error("订单逻辑错误：桌号(tableId)不能为空");break;case"dishes":if(t.name===void 0||t.name==="")throw new Error("菜品逻辑错误：菜品名称(name)不能为空");if(typeof t.price!="number"||t.price<0)throw new Error("菜品逻辑错误：菜品价格(price)必须为非负数");break;case"expenses":if(t.amount===void 0||typeof t.amount!="number"||t.amount<=0)throw new Error("支出逻辑错误：支出金额(amount)必须为正数");if(t.category===void 0||t.category==="")throw new Error("支出逻辑错误：支出类别(category)不能为空");if(t.description===void 0||t.description==="")throw new Error("支出逻辑错误：支出描述(description)不能为空");break;case"inventory":if(t.name===void 0||t.name==="")throw new Error("库存逻辑错误：库存名称(name)不能为空");if(typeof t.quantity!="number"||t.quantity<0)throw new Error("库存逻辑错误：库存数量(quantity)必须为非负数");if(t.unit===void 0||t.unit==="")throw new Error("库存逻辑错误：库存单位(unit)不能为空");break;case"hotel_rooms":if(t.roomNumber===void 0||t.roomNumber==="")throw new Error("酒店房间逻辑错误：房间号(roomNumber)不能为空");if(t.status===void 0||!["available","occupied","maintenance","cleaning"].includes(t.status))throw new Error("酒店房间逻辑错误：房间状态(status)必须为有效值");break;case"sign_bill_accounts":if(t.accountName===void 0||t.accountName==="")throw new Error("签单账户逻辑错误：账户名称(accountName)不能为空");if(typeof t.creditLimit!="number"||t.creditLimit<0)throw new Error("签单账户逻辑错误：信用额度(creditLimit)必须为非负数");break;case"partner_accounts":if(t.name_cn===void 0||t.name_cn==="")throw new Error("合作伙伴账户逻辑错误：单位中文名(name_cn)不能为空");if(t.name_en===void 0||t.name_en==="")throw new Error("合作伙伴账户逻辑错误：单位英文名(name_en)不能为空");if(t.contact_person===void 0||t.contact_person==="")throw new Error("合作伙伴账户逻辑错误：联系人(contact_person)不能为空");if(t.phone===void 0||t.phone==="")throw new Error("合作伙伴账户逻辑错误：联系电话(phone)不能为空");if(typeof t.credit_limit!="number"||t.credit_limit<0)throw new Error("合作伙伴账户逻辑错误：信用额度(credit_limit)必须为非负数");if(typeof t.current_balance!="number"||t.current_balance<0)throw new Error("合作伙伴账户逻辑错误：当前余额(current_balance)必须为非负数");break}}}class f{store=new Map;initialized=!1;async connect(){this.initialized=!0}async disconnect(){this.initialized=!1}async get(e){const t=Date.now();try{this.initialized||await this.connect();const o=this.store.get(e)||null,r=Date.now()-t;return i.recordDatabasePerformance("get",r,this.getEntityType(e)),o}catch(o){const r=Date.now()-t;throw i.error("VirtualDatabase get operation failed",o,{operation:"get",key:e,duration:r}),o}}async set(e,t){const o=Date.now();try{this.initialized||await this.connect(),this.validateData(e,t),this.store.set(e,t);const r=Date.now()-o;i.recordDatabasePerformance("set",r,this.getEntityType(e))}catch(r){const n=Date.now()-o;throw i.error("VirtualDatabase set operation failed",r,{operation:"set",key:e,duration:n}),r}}async delete(e){const t=Date.now();try{this.initialized||await this.connect();const o=this.store.delete(e),r=Date.now()-t;return i.recordDatabasePerformance("delete",r,this.getEntityType(e)),o}catch(o){const r=Date.now()-t;throw i.error("VirtualDatabase delete operation failed",o,{operation:"delete",key:e,duration:r}),o}}async getAll(e){const t=Date.now();try{this.initialized||await this.connect();const o=[];for(const[n,a]of this.store.entries())n.startsWith(e)&&o.push(a);const r=Date.now()-t;return i.recordDatabasePerformance("getAll",r,this.getEntityType(e)),o}catch(o){const r=Date.now()-t;throw i.error("VirtualDatabase getAll operation failed",o,{operation:"getAll",prefix:e,duration:r}),o}}async create(e,t){const o=Date.now();try{this.initialized||await this.connect();const r=this.generateId(),n=new Date().toISOString(),a={...t,id:r,createdAt:n,updatedAt:n};this.validateData(`${e}:${r}`,a),await this.set(`${e}:${r}`,a);const s=Date.now()-o;return i.recordDatabasePerformance("create",s,e),a}catch(r){const n=Date.now()-o;throw i.error("VirtualDatabase create operation failed",r,{operation:"create",prefix:e,duration:n}),r}}async update(e,t,o){const r=Date.now();try{this.initialized||await this.connect();const n=`${e}:${t}`,a=await this.get(n);if(!a)return null;const s={...a,...o,updatedAt:new Date().toISOString()};this.validateData(n,s),await this.set(n,s);const w=Date.now()-r;return i.recordDatabasePerformance("update",w,e),s}catch(n){const a=Date.now()-r;throw i.error("VirtualDatabase update operation failed",n,{operation:"update",prefix:e,id:t,duration:a}),n}}async remove(e,t){const o=Date.now();try{this.initialized||await this.connect();const r=`${e}:${t}`,n=await this.delete(r),a=Date.now()-o;return i.recordDatabasePerformance("remove",a,e),n}catch(r){const n=Date.now()-o;throw i.error("VirtualDatabase remove operation failed",r,{operation:"remove",prefix:e,id:t,duration:n}),r}}generateId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}getEntityType(e){return e.split(":")[0]}validateData(e,t){switch(e.split(":")[0]){case"orders":if(t.total===void 0||t.total===null)throw new Error("订单逻辑错误：总额(total)不能为空");if(t.items===void 0||!Array.isArray(t.items))throw new Error("订单逻辑错误：订单项(items)必须为数组");if(t.tableId===void 0||t.tableId==="")throw new Error("订单逻辑错误：桌号(tableId)不能为空");break;case"dishes":if(t.name===void 0||t.name==="")throw new Error("菜品逻辑错误：菜品名称(name)不能为空");if(typeof t.price!="number"||t.price<0)throw new Error("菜品逻辑错误：菜品价格(price)必须为非负数");break;case"expenses":if(t.amount===void 0||typeof t.amount!="number"||t.amount<=0)throw new Error("支出逻辑错误：支出金额(amount)必须为正数");if(t.category===void 0||t.category==="")throw new Error("支出逻辑错误：支出类别(category)不能为空");if(t.description===void 0||t.description==="")throw new Error("支出逻辑错误：支出描述(description)不能为空");break;case"inventory":if(t.name===void 0||t.name==="")throw new Error("库存逻辑错误：库存名称(name)不能为空");if(typeof t.quantity!="number"||t.quantity<0)throw new Error("库存逻辑错误：库存数量(quantity)必须为非负数");if(t.unit===void 0||t.unit==="")throw new Error("库存逻辑错误：库存单位(unit)不能为空");break;case"hotel_rooms":if(t.roomNumber===void 0||t.roomNumber==="")throw new Error("酒店房间逻辑错误：房间号(roomNumber)不能为空");if(t.status===void 0||!["available","occupied","maintenance","cleaning"].includes(t.status))throw new Error("酒店房间逻辑错误：房间状态(status)必须为有效值");break;case"sign_bill_accounts":if(t.accountName===void 0||t.accountName==="")throw new Error("签单账户逻辑错误：账户名称(accountName)不能为空");if(typeof t.creditLimit!="number"||t.creditLimit<0)throw new Error("签单账户逻辑错误：信用额度(creditLimit)必须为非负数");break;case"partner_accounts":if(t.name_cn===void 0||t.name_cn==="")throw new Error("合作伙伴账户逻辑错误：单位中文名(name_cn)不能为空");if(t.name_en===void 0||t.name_en==="")throw new Error("合作伙伴账户逻辑错误：单位英文名(name_en)不能为空");if(t.contact_person===void 0||t.contact_person==="")throw new Error("合作伙伴账户逻辑错误：联系人(contact_person)不能为空");if(t.phone===void 0||t.phone==="")throw new Error("合作伙伴账户逻辑错误：联系电话(phone)不能为空");if(typeof t.credit_limit!="number"||t.credit_limit<0)throw new Error("合作伙伴账户逻辑错误：信用额度(credit_limit)必须为非负数");if(typeof t.current_balance!="number"||t.current_balance<0)throw new Error("合作伙伴账户逻辑错误：当前余额(current_balance)必须为非负数");break}}}class u{static create(e){switch(e.type){case"neon":try{const{NeonDatabase:t}=require("./neon-database");return new t(e)}catch{return console.warn("Neon数据库模块未找到，使用虚拟数据库作为后备"),new f}default:return console.info(`Using MemoryDatabase for type: ${e.type}`),new m}}}class d{static instance;database=null;constructor(){}static getInstance(){return d.instance||(d.instance=new d),d.instance}async initialize(e){this.database=u.create(e),await this.database.connect(),console.log(`Database initialized with type: ${e.type}`)}getDatabase(){if(!this.database)throw new Error("Database not initialized. Call initialize() first.");return this.database}async reconfigure(e){this.database&&await this.database.disconnect(),await this.initialize(e)}isInitialized(){return this.database!==null}}const p=d.getInstance();export{u as DatabaseFactory,d as DatabaseManager,m as MemoryDatabase,f as VirtualDatabase,p as dbManager};
