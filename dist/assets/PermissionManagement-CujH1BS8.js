import{jsx as e,jsxs as s}from"react/jsx-runtime";import{useState as i,useCallback as M,useEffect as B}from"react";import{AlertCircle as G,Shield as H,Users as J,Plus as C,Save as S,Edit3 as D,Trash2 as _}from"lucide-react";import{a as h}from"./index-CHj5k0ei.js";import"react-dom/client";const Y=()=>{const[o,x]=i([]),[F,w]=i([]),[y]=i([{id:"menu_view",name:"查看菜单",description:"允许查看菜单管理",category:"菜单管理"},{id:"menu_edit",name:"编辑菜单",description:"允许添加/编辑菜单项",category:"菜单管理"},{id:"menu_delete",name:"删除菜单",description:"允许删除菜单项",category:"菜单管理"},{id:"order_view",name:"查看订单",description:"允许查看所有订单",category:"订单管理"},{id:"order_edit",name:"编辑订单",description:"允许修改订单状态",category:"订单管理"},{id:"order_delete",name:"删除订单",description:"允许删除订单",category:"订单管理"},{id:"finance_view",name:"查看财务",description:"允许查看财务报表",category:"财务管理"},{id:"finance_edit",name:"编辑财务",description:"允许添加/修改财务记录",category:"财务管理"},{id:"inventory_view",name:"查看库存",description:"允许查看库存信息",category:"库存管理"},{id:"inventory_edit",name:"编辑库存",description:"允许修改库存信息",category:"库存管理"},{id:"user_manage",name:"用户管理",description:"允许管理用户和角色",category:"系统管理"},{id:"settings_manage",name:"系统设置",description:"允许修改系统设置",category:"系统管理"}]),[R,k]=i(!0),[u,A]=i("roles"),[z,b]=i(!1),[N,g]=i(null),[r,m]=i({name:"",description:"",permissions:[]}),[U,f]=i(!1),[n,v]=i(null),[l,d]=i({username:"",password:"",role:"",isActive:!0}),p=M(async()=>{try{k(!0);const[t,a]=await Promise.all([h.fetchCollection("users"),h.fetchCollection("roles")]);w(t||[]),x(a||[])}catch(t){console.error("加载权限数据失败:",t),alert("加载数据失败: "+(t instanceof Error?t.message:"未知错误")),w([])}finally{k(!1)}},[]);B(()=>{p()},[p]);const E=t=>{if(t.preventDefault(),N){const a=o.map(c=>c.id===N.id?{...c,...r,updatedAt:new Date().toISOString()}:c);x(a)}else{const a={id:`role_${Date.now()}`,...r,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};x([...o,a])}b(!1),g(null),m({name:"",description:"",permissions:[]})},P=t=>{g(t),m({name:t.name,description:t.description,permissions:[...t.permissions]}),b(!0)},$=t=>{window.confirm("确定要删除这个角色吗？关联的用户将失去此角色权限。")&&x(o.filter(a=>a.id!==t))},j=async t=>{t.preventDefault();try{n?(await h.update("users",n.id,{username:n.username,password:l.password||void 0,role:l.role,isActive:l.isActive}),await p(),alert("用户更新成功")):(await h.create("users",{username:l.username,password:l.password,role:l.role,isActive:l.isActive}),await p(),alert("用户创建成功"))}catch(a){console.error("用户操作失败:",a),alert("用户操作失败: "+(a instanceof Error?a.message:"API请求失败"))}f(!1),v(null),d({username:"",password:"",role:"",isActive:!0})},L=t=>{v(t),d({username:t.username,password:"",role:t.role,isActive:t.isActive}),f(!0)},q=async t=>{if(window.confirm("确定要删除这个用户吗？"))try{await h.remove("users",t),await p(),alert("用户删除成功")}catch(a){console.error("删除用户失败:",a),alert("删除用户失败: "+(a instanceof Error?a.message:"API请求失败"))}},T=t=>{m(a=>{const c=a.permissions.includes(t)?a.permissions.filter(O=>O!==t):[...a.permissions,t];return{...a,permissions:c}})},I=t=>{const a=o.find(c=>c.id===t);return a?a.name:t};return R?e("div",{className:"flex h-64 items-center justify-center",children:e("div",{className:"h-8 w-8 animate-spin rounded-full border-b-2 border-slate-900"})}):s("div",{className:"space-y-6",children:[e("div",{className:"rounded-lg border-l-4 border-blue-500 bg-blue-50 p-4",children:s("div",{className:"flex items-start",children:[e(G,{className:"mt-0.5 h-5 w-5 text-blue-500"}),s("div",{className:"ml-3 flex-1",children:[e("h3",{className:"text-sm font-medium text-blue-800",children:"用户管理"}),s("div",{className:"mt-1 text-sm text-blue-700",children:[e("p",{children:"当前用户管理功能已连接到后端API，所有修改将保存到数据库中。"}),e("p",{className:"mt-1",children:"注意：角色和权限管理功能正在开发中，目前仅支持用户基础信息管理。"})]})]})]})}),e("div",{className:"flex items-center justify-between",children:s("div",{children:[e("h2",{className:"text-2xl font-bold text-slate-800",children:"权限管理"}),e("p",{className:"mt-1 text-sm text-slate-500",children:"管理用户角色和系统访问权限"})]})}),e("div",{className:"border-b border-slate-200",children:s("nav",{className:"flex space-x-8",children:[s("button",{onClick:()=>A("roles"),className:`border-b-2 px-1 py-4 text-sm font-medium ${u==="roles"?"border-slate-900 text-slate-900":"border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700"}`,children:[e(H,{className:"mr-2 inline",size:16}),"角色管理"]}),s("button",{onClick:()=>A("users"),className:`border-b-2 px-1 py-4 text-sm font-medium ${u==="users"?"border-slate-900 text-slate-900":"border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700"}`,children:[e(J,{className:"mr-2 inline",size:16}),"用户管理"]})]})}),u==="roles"&&s("div",{className:"space-y-6",children:[e("div",{className:"flex justify-end",children:s("button",{onClick:()=>{g(null),b(!0),m({name:"",description:"",permissions:[]})},className:"flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-white hover:bg-slate-800",children:[e(C,{size:16}),"添加角色"]})}),z&&s("div",{className:"rounded-xl border border-slate-100 bg-white p-6 shadow-sm",children:[e("h3",{className:"mb-4 text-lg font-bold text-slate-800",children:N?"编辑角色":"添加新角色"}),s("form",{onSubmit:E,className:"space-y-4",children:[s("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[s("div",{children:[e("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"角色名称 *"}),e("input",{type:"text",value:r.name,onChange:t=>m({...r,name:t.target.value}),className:"w-full rounded-lg border border-slate-300 px-3 py-2",required:!0})]}),s("div",{children:[e("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"描述"}),e("input",{type:"text",value:r.description,onChange:t=>m({...r,description:t.target.value}),className:"w-full rounded-lg border border-slate-300 px-3 py-2"})]})]}),s("div",{children:[e("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"权限分配"}),e("div",{className:"max-h-96 overflow-y-auto rounded-lg border border-slate-200 p-4",children:Array.from(new Set(y.map(t=>t.category))).map(t=>s("div",{className:"mb-4 last:mb-0",children:[e("h4",{className:"mb-2 font-medium text-slate-800",children:t}),e("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:y.filter(a=>a.category===t).map(a=>s("div",{className:"flex items-center",children:[e("input",{type:"checkbox",id:`perm_${a.id}`,checked:r.permissions.includes(a.id),onChange:()=>T(a.id),className:"rounded border-slate-300 text-slate-900 focus:ring-slate-900"}),e("label",{htmlFor:`perm_${a.id}`,className:"ml-2 text-sm text-slate-700",children:a.name})]},a.id))})]},t))})]}),s("div",{className:"flex gap-3 pt-4",children:[e("button",{type:"button",onClick:()=>{b(!1),g(null)},className:"rounded-lg border border-slate-300 px-4 py-2 text-slate-700 hover:bg-slate-50",children:"取消"}),s("button",{type:"submit",className:"flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-white hover:bg-slate-800",children:[e(S,{size:16}),"保存角色"]})]})]})]}),e("div",{className:"overflow-hidden rounded-xl border border-slate-100 bg-white shadow-sm",children:e("div",{className:"overflow-x-auto",children:s("table",{className:"min-w-full divide-y divide-slate-200",children:[e("thead",{className:"bg-slate-50",children:s("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"角色"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"描述"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"权限数量"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"操作"})]})}),e("tbody",{className:"divide-y divide-slate-200 bg-white",children:o.map(t=>s("tr",{className:"hover:bg-slate-50",children:[e("td",{className:"whitespace-nowrap px-6 py-4",children:e("div",{className:"text-sm font-medium text-slate-900",children:t.name})}),e("td",{className:"whitespace-nowrap px-6 py-4",children:e("div",{className:"text-sm text-slate-500",children:t.description})}),e("td",{className:"whitespace-nowrap px-6 py-4",children:e("span",{className:"inline-flex rounded-full bg-blue-100 px-2 text-xs font-semibold leading-5 text-blue-800",children:t.permissions.length})}),e("td",{className:"whitespace-nowrap px-6 py-4 text-sm font-medium",children:s("div",{className:"flex items-center gap-2",children:[s("button",{onClick:()=>P(t),className:"flex items-center gap-1 text-slate-600 hover:text-slate-900",children:[e(D,{size:14}),"编辑"]}),s("button",{onClick:()=>$(t.id),className:`flex items-center gap-1 ${t.id==="admin"?"cursor-not-allowed text-slate-300":"text-red-600 hover:text-red-900"}`,disabled:t.id==="admin",title:t.id==="admin"?"禁止删除系统默认角色":"",children:[e(_,{size:14}),"删除"]})]})})]},t.id))})]})})})]}),u==="users"&&s("div",{className:"space-y-6",children:[e("div",{className:"flex justify-end",children:s("button",{onClick:()=>{v(null),f(!0),d({username:"",password:"",role:"",isActive:!0})},className:"flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-white hover:bg-slate-800",children:[e(C,{size:16}),"添加用户"]})}),U&&s("div",{className:"rounded-xl border border-slate-100 bg-white p-6 shadow-sm",children:[e("h3",{className:"mb-4 text-lg font-bold text-slate-800",children:n?"编辑用户":"添加新用户"}),s("form",{onSubmit:j,className:"space-y-4",children:[s("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[s("div",{children:[e("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"用户名 *"}),e("input",{type:"text",value:l.username,onChange:t=>d({...l,username:t.target.value}),className:"w-full rounded-lg border border-slate-300 px-3 py-2",required:!0,disabled:!!n})]}),!n&&s("div",{children:[e("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"密码 *"}),e("input",{type:"password",value:l.password,onChange:t=>d({...l,password:t.target.value}),className:"w-full rounded-lg border border-slate-300 px-3 py-2",required:!n,minLength:6,placeholder:"最少 6 位字符"})]}),s("div",{children:[e("label",{className:"mb-1 block text-sm font-medium text-slate-700",children:"角色 *"}),s("select",{value:l.role,onChange:t=>d({...l,role:t.target.value}),className:"w-full rounded-lg border border-slate-300 px-3 py-2",required:!0,children:[e("option",{value:"",children:"请选择角色"}),o.map(t=>e("option",{value:t.id,children:t.name},t.id))]})]}),s("div",{className:"flex items-center gap-2",children:[e("input",{type:"checkbox",id:"isActive",checked:l.isActive,onChange:t=>d({...l,isActive:t.target.checked}),className:"rounded border-slate-300 text-slate-900 focus:ring-slate-900"}),e("label",{htmlFor:"isActive",className:"text-sm text-slate-700",children:"账户激活"})]})]}),s("div",{className:"flex gap-3 pt-4",children:[e("button",{type:"button",onClick:()=>{f(!1),v(null)},className:"rounded-lg border border-slate-300 px-4 py-2 text-slate-700 hover:bg-slate-50",children:"取消"}),s("button",{type:"submit",className:"flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-white hover:bg-slate-800",children:[e(S,{size:16}),"保存用户"]})]})]})]}),e("div",{className:"overflow-hidden rounded-xl border border-slate-100 bg-white shadow-sm",children:e("div",{className:"overflow-x-auto",children:s("table",{className:"min-w-full divide-y divide-slate-200",children:[e("thead",{className:"bg-slate-50",children:s("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"用户名"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"角色"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"状态"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"最后登录"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500",children:"操作"})]})}),e("tbody",{className:"divide-y divide-slate-200 bg-white",children:F.map(t=>s("tr",{className:"hover:bg-slate-50",children:[e("td",{className:"whitespace-nowrap px-6 py-4",children:e("div",{className:"text-sm font-medium text-slate-900",children:t.username})}),e("td",{className:"whitespace-nowrap px-6 py-4",children:e("div",{className:"text-sm text-slate-500",children:I(t.role)})}),e("td",{className:"whitespace-nowrap px-6 py-4",children:t.isActive?e("span",{className:"inline-flex rounded-full bg-green-100 px-2 text-xs font-semibold leading-5 text-green-800",children:"激活"}):e("span",{className:"inline-flex rounded-full bg-slate-100 px-2 text-xs font-semibold leading-5 text-slate-800",children:"禁用"})}),e("td",{className:"whitespace-nowrap px-6 py-4 text-sm text-slate-500",children:t.lastLogin?new Date(t.lastLogin).toLocaleString("zh-CN"):"从未登录"}),e("td",{className:"whitespace-nowrap px-6 py-4 text-sm font-medium",children:s("div",{className:"flex items-center gap-2",children:[s("button",{onClick:()=>L(t),className:"flex items-center gap-1 text-slate-600 hover:text-slate-900",children:[e(D,{size:14}),"编辑"]}),s("button",{onClick:()=>q(t.id),className:`flex items-center gap-1 ${t.username==="admin"?"cursor-not-allowed text-slate-300":"text-red-600 hover:text-red-900"}`,disabled:t.username==="admin",title:t.username==="admin"?"禁止删除系统管理员":"",children:[e(_,{size:14}),"删除"]})]})})]},t.id))})]})})})]})]})};export{Y as default};
